<!DOCTYPE html>
<!-- saved from url=(0052)https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/ -->
<html class=" js no-touch rgba hsla textshadow opacity svg" lang="en"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta http-equiv="Content-Security-Policy-Report-Only" content="default-src &#39;self&#39; ; font-src &#39;self&#39; https://fonts.gstatic.com ; connect-src &#39;self&#39; https://discovery.amp.cloudflare.com https://ralim.report-uri.com; script-src &#39;self&#39; https://www.google-analytics.com https://*.cloudflare.com https://ssl.google-analytics.com https://ajax.googleapis.com https://cdn.report-uri.com https://gist.github.com; style-src &#39;self&#39; &#39;unsafe-inline&#39; https://assets-cdn.github.com https://fonts.googleapis.com 	https://amp.cloudflare.com; img-src &#39;self&#39; https://ssl.google-analytics.com; font-src &#39;self&#39; https://*.fonts.googleapis.com; media-src &#39;self&#39; https://*youtube.com; upgrade-insecure-requests; reflected-xss block; report-uri https://ralim.report-uri.com/r/d/csp/reportOnly ;">
<script type="text/javascript">
//<![CDATA[
window.__cfRocketOptions = {byc:0,p:1520990443,petok:"0b9878bb25508e651a6bc389003c4bfdd1fc5250-1521320038-86400"};
//]]>
</script>
<script type="text/javascript" src="./Adding a secondary sd card on Raspberry PI – Ralim Tek_files/rocket.min.js.download"></script>
<script type="text/json" id="csp-report-uri">
{
	"keys" : ["blockedURI", "columnNumber", "disposition", "documentURI", "effectiveDirective", "lineNumber", "originalPolicy", "referrer", "sample", "sourceFile", "statusCode", "violatedDirective"],
	"reportUri" : "https://ralim.report-uri.com/r/d/csp/reportOnly"
}
</script>
<script data-rocketsrc="https://cdn.report-uri.com/libs/report-uri-js/1.0.0/report-uri-js.min.js" integrity="sha256-/u7ebXQXcESMpl6YCvyBEqs83Wt+JpsaMvO8sXFbIH0=" crossorigin="anonymous" type="text/rocketscript" data-rocketoptimized="true"></script>
<title>Adding a secondary sd card on Raspberry PI – Ralim Tek</title>
<meta name="description" content="Using the SDIO &amp; SPI interface to mount a secondary SD card to the PI">
<meta name="keywords" content="Raspberry, PI, ZeroSD, SDIO, SPI">

<meta name="twitter:title" content="Adding a secondary sd card on Raspberry PI">
<meta name="twitter:description" content="Using the SDIO &amp; SPI interface to mount a secondary SD card to the PI">
<meta name="twitter:site" content="@ralimtek">
<meta name="twitter:creator" content="@ralimtek">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ralimtek.com/images/server.png">

<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Adding a secondary sd card on Raspberry PI">
<meta property="og:description" content="Using the SDIO &amp; SPI interface to mount a secondary SD card to the PI">
<meta property="og:url" content="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/">
<meta property="og:site_name" content="Ralim Tek">
<meta property="og:image" content="https://ralimtek.com/images/server.png">
<link rel="canonical" href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/">
<link href="https://ralimtek.com/feed.xml" type="application/atom+xml" rel="alternate" title="Ralim Tek Feed">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./Adding a secondary sd card on Raspberry PI – Ralim Tek_files/main.css">
<meta http-equiv="cleartype" content="on">

<!--[if lt IE 9]>
	<script src="https://ralimtek.com/assets/js/vendor/html5shiv.min.js"></script>
	<script src="https://ralimtek.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<script data-rocketsrc="https://ralimtek.com/assets/js/vendor/modernizr-2.7.1.custom.min.js" type="text/rocketscript" data-rocketoptimized="true"></script>
<link href="./Adding a secondary sd card on Raspberry PI – Ralim Tek_files/css" rel="stylesheet" type="text/css">


<link rel="shortcut icon" href="https://ralimtek.com/favicon.ico">

<link rel="shortcut icon" href="https://ralimtek.com/favicon.png">

<link rel="apple-touch-icon-precomposed" href="https://ralimtek.com/images/apple-touch-icon-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://ralimtek.com/images/apple-touch-icon-72x72-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://ralimtek.com/images/apple-touch-icon-114x114-precomposed.png">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://ralimtek.com/images/apple-touch-icon-144x144-precomposed.png">
<style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style></head>
<body class="post">
<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->
<div class="navigation-wrapper">
<div class="site-name">
<a href="https://ralimtek.com/">Ralim Tek</a>
</div>
<div class="top-navigation">
<nav role="navigation" id="site-nav" class="nav"><button type="button" role="button" id="menutoggle" class="navtoggle navicon-lines-button x" aria-hidden="true"><span class="navicon-lines"></span>menu</button>
<ul>
<li><a href="https://ralimtek.com/about/">About</a></li>
<li><a href="https://ralimtek.com/posts/">All Posts</a></li>
</ul>
</nav>
</div>
</div>
<div class="image-wrap">
<img src="./Adding a secondary sd card on Raspberry PI – Ralim Tek_files/server.png" alt="Adding a secondary sd card on Raspberry PI feature image">
<span class="image-credit">Photo Credit: <a href="https://ralimtek.com/">Ben Brown</a></span>
</div>
<div id="main" role="main">
<div class="article-author-side">
<div itemscope="" itemtype="http://schema.org/Person">
<img src="./Adding a secondary sd card on Raspberry PI – Ralim Tek_files/benBrown.jpg" class="bio-photo" alt="Ben Brown bio photo">
<h3 itemprop="name">Ben Brown</h3>
<p>Electronics and Embedded Systems Engineering</p>
<a href="mailto:Ralim@Ralimtek.com" class="author-social" target="_blank"><i class="fa fa-fw fa-envelope-square"></i> Email</a>
<a href="https://twitter.com/ralimtek" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
<a href="https://facebook.com/RalimTek" class="author-social" target="_blank"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a>
<a href="https://github.com/Ralim" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
</div>
</div>
<article class="post">
<div class="headline-wrap">
<h1><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/" rel="bookmark" title="Adding a secondary sd card on Raspberry PI">Adding a secondary sd card on Raspberry PI</a></h1>
</div>
<div class="article-wrap">
<section id="table-of-contents" class="toc">
<header>
<h3>Contents</h3>
</header>
<div id="drawer">
<ul id="markdown-toc">
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#warning" id="markdown-toc-warning">WARNING</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#secondary-sd" id="markdown-toc-secondary-sd">Secondary SD</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#sdio-faster-but-only-1-sd-card" id="markdown-toc-sdio-faster-but-only-1-sd-card">SDIO (Faster but only 1 SD card)</a> <ul>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#does-it-work---yes" id="markdown-toc-does-it-work---yes">Does it work? - Yes!</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#wiring" id="markdown-toc-wiring">Wiring</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#software" id="markdown-toc-software">Software</a> <ul>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#1-bit-mode-good-for-spi-sd-breakouts" id="markdown-toc-1-bit-mode-good-for-spi-sd-breakouts">1 bit mode (good for SPI sd breakouts)</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#4-bit-mode-for-everything-else" id="markdown-toc-4-bit-mode-for-everything-else">4 bit mode (For everything else)</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#why-the-poll_onceoff-" id="markdown-toc-why-the-poll_onceoff-">Why the poll_once=off ?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#spi" id="markdown-toc-spi">SPI</a> <ul>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#wiring-1" id="markdown-toc-wiring-1">Wiring</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#software-1" id="markdown-toc-software-1">Software</a> <ul>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#1-sd-card-using-cs-0" id="markdown-toc-1-sd-card-using-cs-0">1 SD card using CS 0</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#two-sd-cards-using-cs-0--cs-1" id="markdown-toc-two-sd-cards-using-cs-0--cs-1">Two sd cards using CS 0 &amp; CS 1</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#creating-a-filesystem-and-mounting-the-sd-card" id="markdown-toc-creating-a-filesystem-and-mounting-the-sd-card">Creating a filesystem and mounting the SD card</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#getting-spi-working-on-a-bcm2832-pi-1--compute-module-1--pi-zero" id="markdown-toc-getting-spi-working-on-a-bcm2832-pi-1--compute-module-1--pi-zero">Getting SPI working on a bcm2832 (Pi 1 / compute module 1 / pi zero)</a> <ul>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#setup-on-compiling-computer" id="markdown-toc-setup-on-compiling-computer">Setup on compiling computer</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#edit-the-driver-to-apply-the-patch" id="markdown-toc-edit-the-driver-to-apply-the-patch">Edit the driver to apply the patch</a> <ul>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#if-compiling-on-the-pi" id="markdown-toc-if-compiling-on-the-pi">If compiling on the pi</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#if-cross-compiling" id="markdown-toc-if-cross-compiling">If cross compiling</a> <ul>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#setting-up-the-toolchain" id="markdown-toc-setting-up-the-toolchain">Setting up the toolchain</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#compiling" id="markdown-toc-compiling">Compiling</a></li>
<li><a href="https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/#installing-onto-sd-card" id="markdown-toc-installing-onto-sd-card">Installing onto SD card</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</section>

<h1 id="warning">WARNING</h1>
<p>If you are planning to use the SPI method on a raspberry pi 1, compute module 1 or a pi zero, please read the extra instructions at the end of the page.
These devices require a driver patch &amp; kernel rebuild. (Its not hard, just slow).</p>
<h1 id="secondary-sd">Secondary SD</h1>
<p>For one of my upcoming projects featuring a raspberry pi zero, extra internal storage is required and I wanted to keep the USB port free for connecting as a OTG connection.</p>
<p>There are two often talked about methods for mounting a second SD card on the Raspberry PI, these are using the SDIO controller and the SPI interface.
I can confirm on kernal 4.4.y both of these methods are usable and can be enabled using the device trees.</p>
<h1 id="sdio-faster-but-only-1-sd-card">SDIO (Faster but only 1 SD card)</h1>
<p>Recently on Hack-A-Day, they featured this project <a href="https://hackaday.io/project/8678/">RPi WiFi over SDIO</a> that covered excellent details on enabling the second SDIO controller in the raspberry pi.
Naturally this controller leads itself to the much simpler task of loading a second SD card to the system as well.</p>
<h2 id="does-it-work---yes">Does it work? - Yes!</h2>
<p>Yep it totally works! Currently I am wired up in ‘1 bit’ mode as I only have spi breakout boards handy, but this already provides a write speed of 4MB/sec which is fantastic as a secondary storage device, and plenty fast for most operations.</p>
<h2 id="wiring">Wiring</h2>
<table>
<thead>
<tr>
<th>Name</th>
<th>SD Card</th>
<th>Raspberry Pi</th>
</tr>
</thead>
<tbody>
<tr>
<td>VCC</td>
<td>4</td>
<td>17</td>
</tr>
<tr>
<td>GND</td>
<td>6</td>
<td>20</td>
</tr>
<tr>
<td>CLK/SCLK</td>
<td>5</td>
<td>15</td>
</tr>
<tr>
<td>CMD/MOSI</td>
<td>2</td>
<td>16</td>
</tr>
<tr>
<td>DAT0/MISO</td>
<td>7</td>
<td>18</td>
</tr>
<tr>
<td>DAT1</td>
<td>8</td>
<td>22</td>
</tr>
<tr>
<td>DAT2</td>
<td>9</td>
<td>37</td>
</tr>
<tr>
<td>DAT3/CS</td>
<td>1</td>
<td>13</td>
</tr>
</tbody>
</table>
<p>Yes it is that simple, I would reccomend putting series termination resistors in your connections if you can (~33 ohms).</p>
<h2 id="software">Software</h2>
<p>To enable the system’s secondary sdio unit onto the raspberry pi pins you need to add the following to your <code class="highlighter-rouge">/boot/config.txt</code> file :</p>
<h3 id="1-bit-mode-good-for-spi-sd-breakouts">1 bit mode (good for SPI sd breakouts)</h3>
<p><code class="highlighter-rouge">dtoverlay=sdio,poll_once=off,bus_width=1</code></p>
<h3 id="4-bit-mode-for-everything-else">4 bit mode (For everything else)</h3>
<p><code class="highlighter-rouge">dtoverlay=sdio,poll_once=off</code></p>
<h3 id="why-the-poll_onceoff-">Why the poll_once=off ?</h3>
<p>Normally linux will only do one set of polling on the bus when the system first boots, but by turning this off the system will keep searching so you can hotswap SD cards (This is also needed for the esp8266 project for different reasons).</p>
<h1 id="spi">SPI</h1>
<p>Using the spi controller is slower but may be desireable (for instance if SDIO is in use by a esp8266).
If you are on a Pi 1, Compute module 1, or Pi Zero, perform the compiling at the end of this page first, then come back here.</p>
<h2 id="wiring-1">Wiring</h2>
<table>
<thead>
<tr>
<th>Name</th>
<th>SD Card</th>
<th>Raspberry Pi</th>
</tr>
</thead>
<tbody>
<tr>
<td>VCC</td>
<td>4</td>
<td>17</td>
</tr>
<tr>
<td>GND</td>
<td>6</td>
<td>20</td>
</tr>
<tr>
<td>CLK/SCLK</td>
<td>5</td>
<td>23</td>
</tr>
<tr>
<td>CMD/MOSI</td>
<td>2</td>
<td>19</td>
</tr>
<tr>
<td>DAT0/MISO</td>
<td>7</td>
<td>21</td>
</tr>
<tr>
<td>DAT1</td>
<td>8</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>DAT2</td>
<td>9</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>DAT3/CS</td>
<td>1</td>
<td>24-0/26-1</td>
</tr>
</tbody>
</table>
<p>Two CS lines, one per SD card (all other pins common).</p>
<h2 id="software-1">Software</h2>
<p>Using the helpful comments at <a href="https://www.raspberrypi.org/forums/viewtopic.php?p=295695">The forum</a> and <a href="https://www.raspberrypi.org/documentation/configuration/device-tree.md">Device Tree’s</a> I was able to construct a working device tree file for mounting the SD card over spi.</p>
<p>First, make sure you are running on an up to date system with the device tree compiler (should be on the newer images automatically I believe)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt update
sudo apt dist-upgrade -y
sudo apt install device-tree-compiler
</code></pre></div></div>
<p>Next, create the file <code class="highlighter-rouge">mmc_spi.dts</code> and open it for editing.
I used nano for this so <code class="highlighter-rouge">nano mmc_spi.dts</code> works well. Save the file anywhere you wish, I used my home directory.</p>
<p>Insert the following into the file</p>
<h3 id="1-sd-card-using-cs-0">1 SD card using CS 0</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dts-v1/;
/plugin/;

/ {
   compatible = "brcm,bcm2835", "brcm,bcm2836", "brcm,bcm2708", "brcm,bcm2709";

   fragment@0 {
      target = &lt;&amp;spi0&gt;;
      frag0: __overlay__ {
         status = "okay";
         sd1 {
                reg = &lt;0&gt;;
                status = "okay";
                compatible = "spi,mmc_spi";
                voltage-ranges = &lt;3000 3500&gt;;
                spi-max-frequency = &lt;8000000&gt;;
         };
      };
   };
};


</code></pre></div></div>
<h3 id="two-sd-cards-using-cs-0--cs-1">Two sd cards using CS 0 &amp; CS 1</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dts-v1/;
/plugin/;

/ {
   compatible = "brcm,bcm2835", "brcm,bcm2836", "brcm,bcm2708", "brcm,bcm2709";

   fragment@0 {
      target = &lt;&amp;spi0&gt;;
      frag0: __overlay__ {
         status = "okay";
         sd1 {
                reg = &lt;0&gt;;
                status = "okay";
                compatible = "spi,mmc_spi";
                voltage-ranges = &lt;3000 3500&gt;;
                spi-max-frequency = &lt;8000000&gt;;
         };
         sd2 {
                reg = &lt;1&gt;;
                status = "okay";
                compatible = "spi,mmc_spi";
                voltage-ranges = &lt;3000 3500&gt;;
                spi-max-frequency = &lt;8000000&gt;;
         };

      };
   };


};

</code></pre></div></div>
<p>Next, compile the created device tree source file with :
<code class="highlighter-rouge">dtc -@ -I dts -O dtb -o mmc_spi.dtbo mmc_spi.dts</code></p>
<p>This should create the file <code class="highlighter-rouge">mmc_spi.dtbo</code> which is a compiled device tree blob file.
The compiler will generate some warnings, but as of current I do not know the best way to solve these, and the file does work. (Kernel 4.9).</p>
<p>For the system to be able to load this blob at boot, we need to copy it to the folder where the dtbo files are kept.</p>
<p><code class="highlighter-rouge"> sudo cp mmc_spi.dtbo /boot/overlays/ </code></p>
<p>Next we need to enable the overlay to be loaded automatically by the operating system. We can force the system to load this overlay on boot by editing the config.txt file</p>
<p><code class="highlighter-rouge">sudo nano /boot/config.txt</code></p>
<p>We want to add <code class="highlighter-rouge">mmc_spi</code> to the end of the file.
If this command is not already in your file anywhere you can just add the line <code class="highlighter-rouge">dtoverlay=mmc_spi</code> at the end.</p>
<p>After this you should be able to reboot and the system will start looking for sd cards on the spi port for you.
Note: If you are using both chip select lines for SD cards, you do NOT want to add <code class="highlighter-rouge">dtparam=spi=on</code> to the file, as the spi port is already being used for the sd cards.</p>
<h1 id="creating-a-filesystem-and-mounting-the-sd-card">Creating a filesystem and mounting the SD card</h1>
<p>After you have your sd card showing up to your system (check with <code class="highlighter-rouge">ls /dev/mmc*</code> and look for mmcblk1 etc) we need to format the sd card if it is not formatted already</p>
<p>For this I refer you <a href="https://help.ubuntu.com/community/InstallingANewHardDrive">here</a> , the Ubuntu guide for a new hard drive.
The sd cards will show up as extra /dev/mmcblk* entries. Make sure you dont try and wipe your boot sd (usually mmcblk0).</p>
<h1 id="getting-spi-working-on-a-bcm2832-pi-1--compute-module-1--pi-zero">Getting SPI working on a bcm2832 (Pi 1 / compute module 1 / pi zero)</h1>
<p>Due to a bug in the SPI DMA driver for the bcm2832, modification of the <code class="highlighter-rouge">spi_mmc.c</code> driver is required, and a subsequent re-build of the modules (and matching kernal).
The modification is simple, however compiling on the pi is realllllly slow (run it over night) or cross compile.
These instructions are lifted from the <a href="https://www.raspberrypi.org/documentation/linux/kernel/building.md">Raspberry Pi Kernel Building</a>
I used cross compiling as I have an Ubuntu server handy, but compiling on device should result in the same details.</p>
<h2 id="setup-on-compiling-computer">Setup on compiling computer</h2>
<p>First, download the source code for the pi kernel / firmware.</p>
<p><code class="highlighter-rouge">git clone --depth=1 https://github.com/raspberrypi/linux</code></p>
<p>Next, install the needed <code class="highlighter-rouge">bc</code> command</p>
<p><code class="highlighter-rouge">sudo apt install bc</code></p>
<h2 id="edit-the-driver-to-apply-the-patch">Edit the driver to apply the patch</h2>
<p>Open the file <code class="highlighter-rouge">linux/drivers/mmc/host/mmc_spi.c</code> in your favourite editor (I just use plain old nano).
In the current file, the line to edit is on line 1394. However it is easy to find for searching for <code class="highlighter-rouge">fail_nobuf1</code> if the file changes.</p>
<p>You want to change the line :</p>
<p><code class="highlighter-rouge">if (spi-&gt;master-&gt;dev.parent-&gt;dma_mask) {</code></p>
<p>To :</p>
<p><code class="highlighter-rouge">if(0){</code></p>
<p>And then save and close the file. This disables some of the DMA settings and lets the sd card work over spi on the older bcm chipset.</p>
<h3 id="if-compiling-on-the-pi">If compiling on the pi</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
cd linux
KERNEL=kernel
make bcmrpi_defconfig
make -j2 zImage modules dtbs
sudo make modules_install
sudo cp arch/arm/boot/dts/*.dtb /boot/
sudo cp arch/arm/boot/dts/overlays/*.dtb* /boot/overlays/
sudo cp arch/arm/boot/dts/overlays/README /boot/overlays/
sudo scripts/mkknlimg arch/arm/boot/zImage /boot/$KERNEL.img

</code></pre></div></div>
<h3 id="if-cross-compiling">If cross compiling</h3>
<p>First you need to install the toolchain.</p>
<h4 id="setting-up-the-toolchain">Setting up the toolchain</h4>
<p><code class="highlighter-rouge">git clone https://github.com/raspberrypi/tools</code></p>
<p>I left this in my home folder for this process (ie its path works out to be /home/username/tools/arm-bc2708/…)</p>
<p>You need to edit your <code class="highlighter-rouge">.bashrc</code> to add the folder to your path so that bash can find the compilers later on.</p>
<p>On x64 bit systems you want to add the following to <code class="highlighter-rouge">$PATH</code></p>
<p><code class="highlighter-rouge">/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin</code></p>
<p>otherwise, on x86 (32 bit) you need to add this :</p>
<p><code class="highlighter-rouge">/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian/bin</code></p>
<p>This can be done by opening .bashrc (its in your home folder) in nano.
Scroll to the bottom of the file and add the following line</p>
<p><code class="highlighter-rouge">PATH=$PATH:/home/userNameHere/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin</code></p>
<p>(or the other path for x86).</p>
<h4 id="compiling">Compiling</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd linux
KERNEL=kernel
make -j 5 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcmrpi_defconfig
make -j 5 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage modules dtbs
</code></pre></div></div>
<h4 id="installing-onto-sd-card">Installing onto SD card</h4>
<p>Having built the kernel, you need to copy it onto your Raspberry Pi and install the modules; this is best done directly using an SD card reader.</p>
<p>First, use lsblk before and after plugging in your SD card to identify it. You should end up with something like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sdb
   sdb1
   sdb2
</code></pre></div></div>
<p>with sdb1 being the FAT (boot) partition, and sdb2 being the ext4 filesystem (root) partition.</p>
<p>If it’s a NOOBS card, you should see something like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sdb
  sdb1
  sdb2
  sdb5
  sdb6
  sdb7
</code></pre></div></div>
<p>with sdb6 being the FAT (boot) partition, and sdb7 being the ext4 filesystem (root) partition.</p>
<p>Mount these first, adjusting the partition numbers for NOOBS cards:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir mnt/fat32
mkdir mnt/ext4
sudo mount /dev/sdb1 mnt/fat32
sudo mount /dev/sdb2 mnt/ext4
</code></pre></div></div>
<p>Next, install the modules:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo make -j 5 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- INSTALL_MOD_PATH=mnt/ext4 modules_install
</code></pre></div></div>
<p>Finally, copy the kernel and Device Tree blobs onto the SD card, making sure to back up your old kernel:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo cp mnt/fat32/$KERNEL.img mnt/fat32/$KERNEL-backup.img
sudo scripts/mkknlimg arch/arm/boot/zImage mnt/fat32/$KERNEL.img
sudo cp arch/arm/boot/dts/*.dtb mnt/fat32/
sudo cp arch/arm/boot/dts/overlays/*.dtb* mnt/fat32/overlays/
sudo cp arch/arm/boot/dts/overlays/README mnt/fat32/overlays/
sudo umount mnt/fat32
sudo umount mnt/ext4
</code></pre></div></div>
<p>Another option is to copy the kernel into the same place, but with a different filename - for instance, kernel-myconfig.img - rather than overwriting the kernel.img file. You can then edit the config.txt file to select the kernel that the Pi will boot into:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kernel=kernel-myconfig.img
</code></pre></div></div>
<p>This has the advantage of keeping your kernel separate from the kernel image managed by the system and any automatic update tools, and allowing you to easily revert to a stock kernel in the event that your kernel cannot boot.</p>
<p>Now plug the card back into your Pi and continue with the normal SPI setup, further up the page.</p>
<hr>
<footer role="contentinfo">
<div class="social-share">
<h4>Share on</h4>
<ul>
<li>
<a href="https://twitter.com/intent/tweet?text=https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
</li>
<li>
<a href="https://www.facebook.com/sharer/sharer.php?u=https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
</li>
<li>
<a href="https://plus.google.com/share?url=https://ralimtek.com/Raspberry_Pi_Secondary_SD_Card/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
</li>
</ul>
</div>
<p class="byline"><strong>Adding a secondary sd card on Raspberry PI</strong> was published on <time datetime="2016-12-10T00:00:00+00:00">December 10, 2016</time> and last modified on <time datetime="2016-12-10">December 10, 2016</time>.</p>
</footer>
</div>
</article>
</div>
<div class="footer-wrap">
<div class="related-articles">
<h4>You might also enjoy <small class="pull-right">(<a href="https://ralimtek.com/posts/">View all posts</a>)</small></h4>
<ul>
<li><a href="https://ralimtek.com/STM32_Double_PWM/" title="STM32 PWMing PWM &amp; Injected ADC">STM32 PWMing PWM &amp; Injected ADC</a></li>
<li><a href="https://ralimtek.com/ElecrowPCB/" title="Elecrow PCB Review">Elecrow PCB Review</a></li>
<li><a href="https://ralimtek.com/ES1006-Tiny-Barcode-Scanner/" title="ES1006 Barcode Scanner">ES1006 Barcode Scanner</a></li>
</ul>
<hr>
</div>
<footer>
<span>© 2018 Ben Brown. Powered by <a href="https://jekyllrb.com/" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a> theme.</span>
</footer>
</div>
<script data-cfasync="false" src="./Adding a secondary sd card on Raspberry PI – Ralim Tek_files/email-decode.min.js.download"></script><script data-rocketsrc="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/rocketscript" data-rocketoptimized="true"></script>
<script type="text/rocketscript" data-rocketoptimized="true">window.jQuery || document.write('<script src="https://ralimtek.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script data-rocketsrc="https://ralimtek.com/assets/js/scripts.min.js" type="text/rocketscript" data-rocketoptimized="true"></script>


</body></html>